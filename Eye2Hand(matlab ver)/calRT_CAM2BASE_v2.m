clc
clear all
%% 采集7组单轴移动数据
% P_C(i): 第i组相机坐标系下采集数据
% T_E2B(i): 第i组末端坐标系到基坐标系的变换阵
% T_C2C(i): 第1组数据P_C(1)到第i组数据P_C(i)的变换阵
P_C = [
%初始位置
-16.997351, -57.407532, 688.27295;
 70.248665, -34.525051, 652.83929;
 26.846586, -4.0707369, 678.34558;
 -58.611023, -81.644325, 701.9859;
%x轴移动+20
-7.5822859, -52.630638, 670.9986;
 79.595482, -29.706947, 635.76746;
 36.306282, 0.78556633, 661.66077;
 -49.143745, -76.877907, 684.6842;
%x轴移动-20
-26.56793, -62.113552, 704.75757;
 60.690166, -39.268337, 669.5835;
 17.266584, -8.819623, 695.11823;
 -68.144653, -86.336578, 718.41528;
%y轴移动+20
0.34239784, -60.843525, 696.95319;
 87.701775, -37.941185, 662.2099;
 44.207752, -7.4838176, 687.5766;
 -41.216576, -85.198341, 710.67847;
%y轴移动-20
-34.498981, -53.846718, 679.09924;
 52.778893, -31.146723, 643.76959;
 9.3937855, -0.61316901, 669.23749;
 -76.101547, -78.029716, 692.71484;
%z轴移动+20
-17.968861, -76.511337, 681.95697;
 69.296173, -53.687515, 647.0769;
 25.950464, -23.20524, 672.59308;
 -59.579239, -100.62765, 695.01733;
%z轴移动-20
-16.114052, -38.247272, 693.88684;
 71.147003, -15.397128, 658.8855;
 27.7617, 15.091245, 684.38898;
 -57.743088, -62.500771, 707.59503;
 ]; 
%读取对应机械臂数据
pose_arm7 = [
[195.74728909151875, 101.3287275766114, 293.81723528690804, 3.1389969684163814, 0.015997270719101005, -2.171999011619311];
[215.74698611461366, 101.32946403996034, 293.81820688563937, 3.1390023791041135, 0.016000885271250848, -2.1719990784784975];
[175.7470095497102, 101.32982765273971, 293.8182254014144, 3.1389984162631555, 0.01600257686332408, -2.1719973197669864];
[195.74639622266008, 121.32874855040484, 293.81846063661027, 3.1390013344659558, 0.015999183028892996, -2.1719990593503913];
[195.74762816830219, 81.32918569129055, 293.8190909417184, 3.1390033893558416, 0.016005502293412403, -2.171999520906368];
[195.7464610201664, 101.3287456305952, 313.817530748224, 3.1389994233431753, 0.01599887702125491, -2.1719989723136077];
[195.74712801137022, 101.32873108128844, 273.8180472128437, 3.139001320276639, 0.016000118243194396, -2.171998941964919]];
%% 求解R_B2C_init
R_B2C_init = calR(P_C(5:end,:));
% % 构造A(i)和B(i)
% T_C2C = zeros(4,4,7);
% A = zeros(4,4,7);
% T_E2B1 = pose2T_E2B(pose_arm7(1,:));
% for i=1:7
%     [R_C2C_i,t_C2C_i] = Kabsch(P_C(1:4,:)',P_C(i*4-3:i*4,:)');
%     T_C2C(:,:,i) = [R_C2C_i,t_C2C_i;0,0,0,1]; 
%     T_E2Bi = pose2T_E2B(pose_arm7(i,:));
%     A(:,:,i) = T_E2Bi*T_E2B1^(-1);
% end
% B = T_C2C;
%% 构造A(i)和B(i)
% 采集N组欧拉角变换数据(变换较大的数据)
pose_arm_N = [
[179.53962045449532, 138.12309758152557, 274.68929336516345, 3.1162298170520657, 0.028496577459602573, -2.0633516791326962];
[204.19122918798067, 155.4725384979118, 299.08157288098414, 2.9891320948569398, 0.32953252989104553, -2.3399937217259508];
[236.90588320629823, 108.87887943965153, 283.00803729690404, -3.1039128841100543, 0.27097334534803164, -2.1569813009688064];
[208.85510427259507, 156.11785491676235, 254.8210996149748, 2.914614707101179, 0.2618705083357623, -2.2450719328243776];
[198.90247850079717, 201.83530178996776, 289.0929005058144, 2.847812162149429, 0.3059486910187969, -2.1702068740911553];
[284.21416606284953, 66.84025652032525, 267.2321768086234, 2.7840195770733427, 0.24275041054243543, -2.7291821697031464];
[266.9107424112627, 33.72030016026653, 259.49645499651655, 3.0602698930044556, 0.11611589966669385, -2.2872524332419135];
[205.67613466814132, 120.57421981643499, 299.9600251602486, -3.0786732471768246, 0.3998907835122953, -2.047046486366415];
[207.71939937147428, 158.49206276170554, 320.8919271792529, 3.0895793518692876, 0.6923644734782484, -2.051566018129093];
[205.92750044941792, 36.49684862062597, 311.30395511400025, -2.748760025933699, -0.07539299760423948, -2.2393490627862764]
];
% 对应的相机坐标系坐标值
P_C_N = [
12.39718, -51.067814, 728.78113;
 103.78207, -31.644859, 703.33881;
 59.363312, 0.39002752, 724.97278;
 -31.323868, -73.630211, 737.97479;
49.748497, -81.11322, 699.9057;
 130.33144, -77.583725, 646.09143;
 103.68002, -40.188721, 683.25092;
 6.7456264, -95.090118, 720.90881;
24.66367, -50.223114, 652.14099;
 111.90746, -50.991535, 610.3053;
 79.009094, -9.638835, 636.38354;
 -20.27849, -62.995659, 670.20874;
55.098289, -36.603127, 720.80756;
 141.97406, -28.252602, 678.59875;
 110.00163, 5.9195857, 714.35492;
 9.9714136, -52.689903, 735.28412;
93.56633, -83.990189, 747.02637;
 183.86163, -80.413101, 711.81995;
 151.95828, -45.707253, 747.44958;
 46.247208, -97.137833, 757.13727;
1.3232899, -8.616745, 602.06769;
 60.857243, 15.418862, 529.6474;
 45.330551, 40.953335, 580.61328;
 -32.815331, -31.265982, 630.00659;
-36.852348, 2.1129627, 607.47052;
 46.320995, 21.035496, 561.59326;
 9.3398266, 52.756016, 594.87775;
 -78.187424, -20.005245, 624.7276;
28.899591, -85.229477, 680.20978;
 117.11668, -100.67174, 643.53583;
 89.640434, -53.961361, 666.35266;
 -18.339634, -90.332855, 696.05487;
74.030388, -129.76398, 691.12952;
 153.53601, -166.11559, 649.97028;
 141.31296, -116.09498, 678.8421;
 27.500439, -122.63711, 708.32178;
-81.373848, -64.606766, 617.79224;
 1.3321106, -43.838955, 572.31262;
 -46.341267, -12.749725, 586.82153;
 -118.72324, -87.826431, 640.77649;
];
N = size(pose_arm_N, 1);
T_C2C_N = zeros(4,4,N);
A_N = zeros(4,4,N);
T_E2B1 = pose2T_E2B(pose_arm_N(1,:));
for i=1:10
    [R_C2C_i,t_C2C_i] = Kabsch(P_C_N(1:4,:)',P_C_N(i*4-3:i*4,:)');
    T_C2C_N(:,:,i) = [R_C2C_i,t_C2C_i;0,0,0,1]; 
    T_E2Bi = pose2T_E2B(pose_arm_N(i,:));
    A_N(:,:,i) = T_E2Bi*T_E2B1^(-1);
end
B_N = T_C2C_N;
err_list = zeros(N, 1);
for i=1:N
    R_B = B_N(1:3,1:3,i);
    R_A = A_N(1:3,1:3,i);
    t_A= A_N(1:3,4,i);
    t_B= B_N(1:3,4,i);
    delta_err = R_B2C_init*R_A-R_B*R_B2C_init;
    err_list(i) = sum(sum(delta_err.^2))/numel(delta_err);
end
err_list'
% t_B2C_init = (R_B-eye(3))^(-1)*(R_B2C_init*t_A-t_B)
%% 求优T_B2C
t_base2cam = [-188.510  82.918  790.387];  % 使用标识球靠近底座位置在光学定位系统上粗略定位
[r1,r2,r3] = dcm2angle(R_B2C_init);

% %使用tsai方法求解AX = XB
% T_B2C = tsai(B_N, A_N)  % 误差太大，弃用

% 使用求优工具箱求解
para0 = [r1,r2,r3,t_base2cam];
paraRang = [0.5*pi*ones(1,3), 50*ones(1,3)];
options= optimoptions('fmincon','Algorithm','active-set','Display','iter');
isAgain=1; mErr=10; paraDelta=1;
while (isAgain||mErr>0.08)&&paraDelta>0.001
    [paras,mErr]= fmincon(@(para)computeErro(A_N, B_N, para),para0,[],[],[],[],para0-paraRang,para0+paraRang,[],options);  
    paraDelta = sum(abs(paras-para0));
    isAgain = sum(((abs(paraRang)-abs(paras-para0))<0.001));
    para0 = paras;
end
% T_B2C求优结果
R_B2C = angle2dcm(para0(1),para0(2),para0(3));
t_B2C = para0(4:6);
T_B2C_opt = [R_B2C, t_B2C';0,0,0,1];
mErr

%% 验证误差:AX-XB
for i=2:size(A_N, 3)
    delta((i-1)*4-3:(i-1)*4,:) = T_B2C_opt*A_N(:,:,i)-B_N(:,:,i)*T_B2C_opt;
end
delta 
%% T_E2o
temp = [0.00000000e+00, 9.68285131e+01, 5.56483956e+01, -4.82045988e+01;
        0.00000000e+00, 0.00000000e+00, 4.20890318e+01, -1.34696577e+01;
        0.00000000e+00, 0.00000000e+00, 0.00000000e+00, -1.26345480e-02];
% 计算T_C2o和T_E2B
[r,t] = Kabsch(P_C_N(1:4,:)', temp);
T_C2o = [r,t;0,0,0,1];
T_E2B = pose2T_E2B(pose_arm_N(1,:));
T_E2o = T_C2o*T_B2C_opt*T_E2B

% T_E2o =
% 
%    -0.9288   -0.3294    0.1700  -56.2382
%     0.2018   -0.0645    0.9773  -61.4003
%    -0.3110    0.9420    0.1263    9.1370
%          0         0         0    1.0000

function RMSE = computeErro(A, B, para)
    R_B2C = angle2dcm(para(1),para(2),para(3));
    t_B2C = para(4:6);
    T_B2C = [R_B2C, t_B2C';0,0,0,1];
    delta = zeros(4*(size(A, 3)-1),4);
    for i=2:size(A, 3)
        delta((i-1)*4-3:(i-1)*4,:) = T_B2C*A(:,:,i)-B(:,:,i)*T_B2C;
        MSE = sum(sum(delta.^2))/numel(delta);
        RMSE = sqrt(MSE);
    end
end